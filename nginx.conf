user  nginx;
worker_processes  auto;  # Determined automatically by the number of CPU cores

error_log  /var/log/nginx/error.log warn;

events {
  worker_connections 1024;
}

http {
  server_tokens off;
  absolute_redirect off;
  access_log /var/log/nginx/access.log;
  default_type application/octet-stream;
  error_log /var/log/nginx/error.log;
  include /etc/nginx/mime.types;
  keepalive_timeout 3000;
  sendfile on;

  server {
    listen 8080;
    root /usr/share/nginx/html;
    index index.html;
    server_name_in_redirect on;

    add_header X-Frame-Options "deny";
    add_header X-XSS-Protection "1; mode=block";
    add_header X-Content-Type-Options "nosniff";

    charset utf-8;

    # Global gzip settings for normal content
    gzip on;
    gzip_disable "msie6";
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_buffers 16 8k;
    gzip_http_version 1.1;
    gzip_min_length 256;
    gzip_types text/css application/json application/javascript application/x-javascript text/javascript application/vnd.ms-fontobject application/x-font-ttf font/opentype image/svg+xml image/x-icon;

    client_max_body_size 32m;
    error_page 500 502 503 504 /50x.html;
    error_page 404 /404.html;

    recursive_error_pages on;

    # Dedicated location for pre-compressed JavaScript files
    location ~* \.js\.gz$ {
      gzip off;
      add_header Content-Encoding gzip;
      add_header Content-Type application/javascript;
      try_files $uri =404;
    }

    # Dedicated location for pre-compressed WebAssembly files
    location ~* \.wasm\.gz$ {
      gzip off;
      add_header Content-Encoding gzip;
      add_header Content-Type application/wasm;
      try_files $uri =404;
    }

    # Dedicated location for pre-compressed data files
    location ~* \.data\.gz$ {
      gzip off;
      add_header Content-Encoding gzip;
      add_header Content-Type application/octet-stream;
      try_files $uri =404;
    }

    # Dedicated location for pre-compressed JSON symbols files
    location ~* \.symbols\.json\.gz$ {
      gzip off;
      add_header Content-Encoding gzip;
      add_header Content-Type application/json;
      try_files $uri =404;
    }

    # Main location block for all other requests
    location / {
      # For Next.js static exports: maps /page to page/index.html if needed
      try_files $uri $uri.html $uri/index.html =404;
    }

    location ~* ^/404\.html$ {
      # Enable userland 404 handling
      try_files /404.html /404/index.html;
      error_page 404 = @error404;
    }

    location @error404 {
      root /usr/share/nginx/errors/;
    }

    location /50x.html {
      root /usr/share/nginx/errors/;
    }

    location /live {
      default_type text/plain;
      return 200 'OK';
    }

    include /etc/nginx/ready_response.conf;
    location /ready {
      default_type text/plain;
      if ($ready_response = 'OK') {
        return 200 $ready_response;
      }
      return 500 'Not Ready';
    }
  }
}
